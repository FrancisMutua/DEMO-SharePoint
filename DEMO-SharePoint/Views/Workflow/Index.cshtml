@model DEMO_SharePoint.Models.WorkflowConfigVM

@{
    ViewBag.Title = "Workflow Management";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="fw-bold mb-1">Workflow Management</h3>
            <p class="text-muted mb-0">Manage document approval workflows</p>
        </div>

        <button class="btn btn-primary shadow-sm"
                data-bs-toggle="modal"
                data-bs-target="#addWorkflowModal">
            <i class="bi bi-plus-lg"></i> Add Workflow
        </button>
    </div>

    <!-- Workflows Card -->
    <div class="card shadow-sm border-0">
        <div class="card-body p-0">

            @if (Model.ExistingWorkflows != null && Model.ExistingWorkflows.Any())
            {
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Workflow</th>
                                <th>Library</th>
                                <th>Levels</th>
                                <th>Approvers</th>
                                <th>Status</th>
                                <th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var wf in Model.ExistingWorkflows)
                            {
                                <tr>
                                    <!-- Workflow Name -->
                                    <td>
                                        <div class="fw-semibold">@wf.WorkflowName</div>
                                        <small class="text-muted">
                                            @wf.Levels Approval Levels
                                        </small>
                                    </td>

                                    <!-- Library -->
                                    <td>
                                        <span class="badge bg-light text-dark border">
                                            @wf.LibraryUrl
                                        </span>
                                    </td>

                                    <!-- Levels -->
                                    <td>
                                        @if (wf.Stages != null && wf.Stages.Any())
                                        {
                                            foreach (var stage in wf.Stages)
                                            {
                                                <span class="badge bg-info text-dark me-1">
                                                    Level @stage.Level
                                                </span>
                                            }
                                        }
                                        else
                                        {
                                            <span class="text-muted">No stages</span>
                                        }
                                    </td>

                                    <!-- Approvers -->
                                    <td style="min-width: 250px;">
                                        @if (wf.Stages != null && wf.Stages.Any())
                                        {
                                            foreach (var stage in wf.Stages)
                                            {
                                                <div class="mb-1">
                                                    <small>
                                                        <span class="fw-semibold">
                                                            Level @stage.Level:
                                                        </span>

                                                        @if (stage.Approvers != null && stage.Approvers.Any())
                                                        {
                                                            @(string.Join(", ", stage.Approvers))
                                                        }
                                                        else
                                                        {
                                                            <span class="text-muted">No approvers</span>
                                                        }
                                                    </small>
                                                </div>
                                            }
                                        }
                                        else
                                        {
                                            <span class="text-muted">Not configured</span>
                                        }
                                    </td>

                                    <!-- Status -->
                                    <td>
                                        <span class="badge @(wf.IsActive ? "bg-success" : "bg-secondary")">
                                            @(wf.IsActive ? "Active" : "Inactive")
                                        </span>
                                    </td>

                                    <!-- Actions -->
                                    <td class="text-end">
                                        <button class="btn btn-sm btn-outline-danger"
                                                onclick="deleteWorkflow(@wf.Id)">
                                            <i class="bi bi-trash"></i>
                                            Delete
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="text-center py-5">
                    <div class="mb-3">
                        <i class="bi bi-diagram-3 fs-1 text-muted"></i>
                    </div>
                    <h5 class="fw-semibold">No Workflows Configured</h5>
                    <p class="text-muted">
                        Create your first workflow to start managing approvals.
                    </p>
                </div>
            }

        </div>
    </div>


<!-- Add Workflow Modal -->
<div class="modal fade" id="addWorkflowModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Workflow</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label>Workflow Name</label>
                    <input id="workflowName" class="form-control" placeholder="e.g. Finance Approval Workflow" />
                </div>
                <div class="mb-3">
                    <label>Target Library</label>
                    <select id="libraryUrl" class="form-select">
                        <option value="">Select Library</option>
                        @foreach (var lib in Model.Libraries)
                        {
                            <option value="@lib.Url">@lib.Title</option>
                        }
                    </select>
                </div>
                <div class="mb-3">
                    <label>Approval Levels</label>
                    <select id="approvalLevels" class="form-select">
                        <option value="">Select Levels</option>
                        @foreach (var lvl in Model.ApprovalLevels)
                        {
                            <option value="@lvl.Value">@lvl.Text</option>
                        }
                    </select>
                </div>
                <div id="levelsContainer"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button class="btn btn-success" onclick="saveWorkflow()">Save Workflow</button>
            </div>
        </div>
    </div>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script>
    let userSearchTimer;

    $(document).on('keyup', '.approver-input', function () {

        const input = $(this);
        const query = input.val().trim();
        const dropdown = input.siblings('.user-dropdown');

        clearTimeout(userSearchTimer);

        if (query.length < 2) {
            dropdown.addClass('d-none').empty();
            return;
        }

        userSearchTimer = setTimeout(() => {

            $.ajax({
                url: '/Home/SearchUsers',
                type: 'GET',
                data: { term: query },
                success: function (res) {

                    dropdown.empty();

                    if (!res || res.length === 0) {
                        dropdown.addClass('d-none');
                        return;
                    }

                    res.forEach(u => {
                        dropdown.append(`
                        <li class="list-group-item list-group-item-action user-item"
                            data-login="${u.Login}">
                            <strong>${u.DisplayName}</strong><br/>
                            <small class="text-muted">${u.Login}</small>
                        </li>
                    `);
                    });

                    dropdown.removeClass('d-none');
                }
            });

        }, 300);
    });


    $(document).on('click', '.user-item', function () {

        const login = $(this).data('login');
        const dropdown = $(this).closest('.user-dropdown');
        const input = dropdown.siblings('.approver-input');

        input.val(login);
        dropdown.addClass('d-none').empty();
    });


    $(document).ready(function () {
        $('#approvalLevels').on('change', function () {
            let levels = parseInt($(this).val());
            let container = $('#levelsContainer');
            container.empty();
            if (!levels) return;

            for (let i = 1; i <= levels; i++) {
                container.append(
                    `<div class="card mb-2">
                    <div class="card-body">
                        <strong>Level ${i} Approvers</strong>
                       <div class="position-relative mt-2">
    <input type="text"
           class="form-control approver-input"
           data-level="${i}"
           placeholder="Search user..." />

    <ul class="list-group position-absolute w-100 user-dropdown d-none"
        style="z-index:1055;"></ul>
</div>

                    </div>
                </div>`
                );
            }
        });
    });
    function saveWorkflow() {

        let workflowName = $('#workflowName').val().trim();
        let libraryUrl = $('#libraryUrl').val();
        let levels = parseInt($('#approvalLevels').val());
        let token = $('input[name="__RequestVerificationToken"]').val();

        let isValid = true;

        // Reset validation UI
        $('.form-control, .form-select').removeClass('is-invalid');

        // Basic validations
        if (!workflowName) {
            $('#workflowName').addClass('is-invalid');
            isValid = false;
        }

        if (!libraryUrl) {
            $('#libraryUrl').addClass('is-invalid');
            isValid = false;
        }

        if (!levels) {
            $('#approvalLevels').addClass('is-invalid');
            isValid = false;
        }

        let stages = [];

        $('.approver-input').each(function () {

            let level = parseInt($(this).data('level'));
            let rawValue = $(this).val().trim();

            if (!rawValue) {
                $(this).addClass('is-invalid');
                isValid = false;
                return;
            }

            // Split by comma (if you allow multiple)
            let users = rawValue
                .split(',')
                .map(x => x.trim())
                .filter(x => x.length > 0);

            // Remove duplicates
            users = [...new Set(users)];

            if (users.length === 0) {
                $(this).addClass('is-invalid');
                isValid = false;
                return;
            }

            stages.push({
                Level: level,
                Approvers: users
            });
        });


        if (!isValid) {
            Swal.fire('Error', 'Please fill all fields correctly. Each level must have valid email approvers.', 'error');
            return;
        }

        if (stages.length !== levels) {
            Swal.fire('Error', 'All levels must be configured.', 'error');
            return;
        }

        $.ajax({
            url: '/Workflow/CreateWorkflow',
            type: 'POST',
            contentType: 'application/json',
            headers: { 'RequestVerificationToken': token },
            data: JSON.stringify({
                Name: workflowName,
                LibraryUrl: libraryUrl,
                Levels: levels,
                Stages: stages
            }),
            success: function (res) {
                if (res.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Workflow saved!',
                        timer: 1500,
                        showConfirmButton: false
                    }).then(() => location.reload());
                } else {
                    Swal.fire('Error', res.message || 'Error saving workflow', 'error');
                }
            },
            error: function () {
                Swal.fire('Error', 'Server error occurred.', 'error');
            }
        });
    }

    function deleteWorkflow(id) {
        let token = $('input[name="__RequestVerificationToken"]').val();

        Swal.fire({
            title: 'Are you sure?',
            text: "This workflow will be deleted!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Yes, delete it!',
            cancelButtonText: 'Cancel'
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: '/Workflow/DeleteWorkflow',
                    type: 'POST',
                    data: { __RequestVerificationToken: token, id: id },
                    success: function (res) {
                        if (res.success) {
                            Swal.fire({
                                icon: 'success',
                                title: 'Deleted!',
                                timer: 1200,
                                showConfirmButton: false
                            }).then(() => location.reload());
                        } else {
                            Swal.fire('Error', res.message || 'Failed to delete', 'error');
                        }
                    },
                    error: function () {
                        Swal.fire('Error', 'Server error', 'error');
                    }
                });
            }
        });
    }

</script>
